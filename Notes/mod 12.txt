M12 L1
Web Configuration
File

Lecture Outline
| Web Configuration File and Its Elements
| Reading & Writing AppSettings in User
Program

| Policy-Based Computing

| Web Configuration File Inheritance

2

ASP.Net Application and Its Components
◼

ASPX files containing Web forms

◼

ASCX files containing user controls

◼

Web.config files containing

configuration settings
◼

A Global.asax file containing

global application elements
◼

DLL (dynamic link library) files containing
custom types employed by the application
3

Web.config File
◼

◼

◼

◼

◼

◼

.Net supports XCOPY deployment: Install software by simply
drag and drop the software folder, uninstall software by deleting
the folder;
Keep the text-based configuration file with the application,
instead of putting it in the system registry;
Every Web service and Web application automatically includes a
Web.config file;
The file is never locked when the application is running, and it
can be edited at any time, statically and dynamically;
The files is transferable to other applications: simply copy and
paste;
The file is easily readable for both human and machine.
4

Web.config File Structure
◼
◼

Web.config file is an XML file
It controls various settings, including
◼
◼
◼

Application data and parameter values
Communication protocols
Authentication and authorization setting (to be discussed in chapter 6)
root

configuration

appSettings

system.web

...

...

...

...

...

...

...

5

Web.config File: appSettings
root
configuration

appSettings

system.web

...

<?xml version = “1.0” ?>
<configuration>
<appSettings> <!-- appSetting here --> </appSettings>
<connectionStrings> <!-- cS setting --> </connectionStrings>
<system.web>
<!--ASP.Net configuration settings -->
<system.web>
<system.codedom> <!-- setting --> </ system.codedom>
<system.webServer> <!-- setting --> </ system.webServer>
<configuration>
6

Reading & Writing AppSettings in Program
▪ Data stored in AppSettings can be accessed in the program.
▪ There are different ways of accessing the data;
▪ Example: Design a Web Site App to Modify appSettings

Click twice
Click

Click

Click this on another
computer, you will
also see the values.
7

Code Behind the Page: Write
protected void btnSave_Click(object sender, EventArgs e) {
System.Configuration.Configuration config =
System.Web.Configuration.WebConfigurationManager.
OpenWebConfiguration("~/"); // Open Web.config file
// Create a new element into appSettings.
Open the
Web.config file
int index =
System.Configuration.ConfigurationManager.AppSettings.Count;
string newKey = txtKey.Text + index.ToString(); // from textbox
string newValue = txtValue.Text; // from textbox
Add the new
pair into
// Modify the appSettings in Web.config file.
AppSettings
config.AppSettings.Settings.Add(newKey, newValue);
// Save the changes into the Web.config file.
config.Save(System.Configuration.ConfigurationSaveMode.Modified);
}
Save the changes to the disk

8

Code Behind the Page: Read
protected void btnRead_Click(object sender, EventArgs e)
{
System.Collections.Specialized.NameValueCollection myKeys =
System.Web.Configuration.WebConfigurationManager.AppSettings;
lblDisplay.Text = "";
Create an object
for (int i = 0; i < myKeys.Count; i++)
of AppSettings
{
string appEntry = String.Format("Key {0}: {1} Value: {2} <br/>",
i, myKeys.GetKey(i), myKeys[i]);
lblDisplay.Text += appEntry;
}
Formating the
AppSettings object
}
for display

9

Code Behind the Page: Delete
using System;
using System.Xml;
protected void btnDelete_Click(object sender, EventArgs e)
Use XmlDocument
{
class
XmlDocument myCF = new XmlDocument();
myCF.Load(AppDomain.CurrentDomain.SetupInformation.ConfigurationFile);
foreach (XmlElement appElement in myCF.DocumentElement)
{
Find appSettings
element
if (appElement.Name.Equals("appSettings"))
{
Remove all
appElement.RemoveAll();
child elements
lblDisplay.Text = "All AppSettings elements are removed";
}
}
myCF.Save(AppDomain.CurrentDomain.SetupInformation.ConfigurationFile);
}
10
Save the file

Policy-Based Computing
Policy-based computing refers to a software development model
that incorporates a set of decision-making parameters into a
separate management component (called policy data store or
policy-base) in order to simplify and automate the administration
of computer systems;
◼ Policies are items returned from a policy data store and used at
runtime by application software. Examples of policies:
◼ Password must use between 8 and 12 characters AND at least
one letter and one digit.
◼ Door unlocks at 7am and locks at 6pm
◼ Instead of hard coding the specific parameter values into the
program, the values are stored in policy data store, which can be
modified while the processing program is running.
◼

11

Using <appSettings> vs. Hard Coding
◼

◼

◼

The purpose is to parameterize an application’s behavior, and to
allow the behavior to be modified without changing &
recompiling the source code.
<appSettings> section holds the application specific values
(strings) that can be read during execution.
It is the basic form of policy-based computing.
Example: Hard-coded SQL access string

SqlDataAdapter adapter = new SqlDataAdapter
(“select * from titles where price != 0”,
“server=hawkeye; database=pubs; uid=sa; pwd=”);
DataSet ds = new DataSet ();
adapter.Fill (ds);
Hard
Hard
coded

coded

Hard
coded

12

Example: Store Custom Setting in <AppSetting>
<appSettings>
<add key= “xDataFile” value= “c:%myAspApps%Docs%xmlDoc=” />
</appSettings>

Public partial class myApp : System.Web.UI.Page
{
protected void Page_Load( );
{
lblResult.Text = “Display data in xmlDoc here: <br />”;
lblResult.Text += WebConfigurationManager.appSettings[“xDataFile”];
lblResult.Text += “<br />”
}
}
Supporting policybased computing.
13

Using <appSettings> instead of Hard Coding
String conn =
ConfigurationSettings.appSettings[“MyConnectionString”];
SqlDataAdapter adapter = new SqlDataAdapter
(“select * from titles where price != 0”, conn);
DataSet ds = new DataSet ();
adapter.Fill (ds);
Page_Load extracts the connection
string from the Web.config file

<configuration>
<appSettings>
<add key= “MyConnectionString” value=
“server=hawkeye;database=pubs;uid=sa;pwd=” />
</appSettings>
</configuration>
14

<system.web> Element
◼

◼

◼

system.web

The system.web section of Web.config holds configuration settings used by
the system -- ASP.NET.
Its content is categorized by subsections. Developers are free to define
custom subsections.
The following subsections are supported by default and can be used without
writing custom configuration handlers.

authentication Sets the authentication mode and specifies settings for the
mode selected
authorization Specifies who is allowed to access resources in this directory
and its subdirectories
browserCaps Maps user-agent data to browser capabilities
clientTarget Maps user-agent data to browser types
compilation Specifies run-time compilation settings such as whether
executables should be compiled with debug symbols, maps
file name extensions and Language attributes to compilers,
and identifies the assemblies that ASP.NET links to.
15

<system.web> Element -- continued
customErrors Enables the use of custom error pages and specifies how errors should be
reported on clients and servers
httpRuntime Specifies request time-outs and other settings used by ASP.NET runtime
globalization Specifies character encodings for requests and responses
httpHandlers Maps URLs to HVFP handlers (for example, maps requests for ASPX
files to System. Web.UI.PageHandlerFactoiy)
httpModules Identifies HTTP modules called in response to HUP requests
identity
Controls the identity that ASP.NET assigns to individual requests
machineKey Specifies encryption and validation settings (for example, the key
and algorithm used to encrypt authentication cookies)
pages
Specifies page-level configuration settings such as whether output
buffering, session state, and view state are enabled
processModel Specifies configuration settings for ASP.NET worker processes
securityPolicy Maps trust levels to CONFIG files containing security policies
sessionState Specifies session state settings (e.g., where session state is stored)
trace
Enables and disables tracing and specifies trace settings
trust
Specifies the code access security trust level
webControls Identifies the location on the server of client scripts used by
ASP.NET Web controls
webServices Contains Web service settings
16

Example of <system.web> Element
<configuration>
<system.web>
<trace enabled=“true” I>
<Isystem.web>
</configuration>

Empty element

<configuration>
<system.web>
<trace enabled=“true” />
<sessionState mode=“SQLServer”
sqlConnectionString=“server=localhost;uid=sa;pwd=”/>
<compilation debug=“true” defaultLanguage=“c#” />
<pages enableViewStateMac=“true” />
</system.web>
</configuration>
17

Example of <system.web> Element

<configuration>
<system.web>
<machineKey ... />
</system.web>
</configuration>

The machineKey is
normally generated
automatically. However, if
we use a Web Farm, the
auto-generated key does not
work. We need to change
the setting, See WebStrar
Tutorial.

https://support.microsoft.com/en-us/kb/2915218?wa=wsignin1.0#AppendixA
18

Debugging Information in Web.config File

4.0

Remove the
targetFramework 4.5 if the
server does not support
this version. Otherwise,
the JIT compiler throws
an error.

19

Define Your targetFramework

Right-Click Solution

20

Web Configuration File Inheritance
ASP .Net web machine
root
.config .config

inherit
MyWebApp
Global
.asax

Web
.config

.aspx
.aspx
.aspx
files
files
files

.ascx
.aspx
.aspx
files
files
files

<configuration>
<system.web>
<compilation
defaultLanguage=“c#”/>
</system.web>
</configuration>
inherit

CSHARPFILES

VBFILES

.aspx
.aspx
.aspx
files
files
files

.aspx
.aspx
.aspx
files
files
files

inherit

Web
.config

<configuration>
<system.web>
<compilation
defaultLanguage=“vb”/>
</system.web>
</configuration>
override
21

Using ASP.Net Website Admin Tool
◼

In VS, select Website → ASP.Net Configuration

22

M12 L2
Global and DLL

Lecture Outline
Unique
MyWebApp root

| Global File
- Global Directives

- Global Event Handler

Global
.asax

Web
.config

.aspx
.aspx
.aspx
files
files
files

.ascx
.aspx
.aspx
files
files
files

- Global Objects and Variable

| DLL: Dynamic Linking Library
bin

.dll
.aspx
.aspx
file
files
files

.exe
.aspx
.aspx
file
files
files

Global.asax File

◼

◼

◼

Global.asax is a text file that houses global directives,
application-level event handlers, declarations that
apply to all parts of the application, and other global
application elements.
Global directives
◼ @ Application directives
◼ @ Import directives
◼ @ Assembly directives
Global event handlers: particularly important and are
the main reason why developers include Global.asax
files in their applications
Global objects (variables)
3

@ Application Directives in Global.asax
◼

@ Application directives serve two purposes:
◼ Enable developers to add descriptive text
(comments) to applications, and
◼ Facilitate programming in Global.asax files.

<%@ Application Description = “MY ASP.NET Application with Global Directives” %>
<%@ Import Namespace= “System.Data” %>
Support DataSet
<script language=“C#” runat=“server”>
void Application_Start ()
{
This code will
DataSet ds = new DataSet ();
be compiled at
ds.ReadXml (Server.MapPath (“GlobalData.xml”));
runtime:
Application[“GlobalData”] = ds;
Pro: flexibility
Con: cold start
}
</script>
4

@ Application Directives in Global.asax
Write the code as a C# program (.cs) and pre-compile the code
into .DLL file, e.g., MyStarter.dll

◼

using System.Web;
using System.Data;
public class MyStarter : HttpApplication
{
void Application_Start ()
{
DataSet ds = new DataSet ();
ds.ReadXml (Server.MapPath (“GlobalData.xml”));
Application[“GlobalData”] = ds;
}
}
◼

In Global.asax file, use this line to invoke the program
<%@ Application inherits = “MyStarter” %>
5

Global Event Handlers in Global.asax
◼

ASP.NET fires global events named Start and End,
when an application starts and stops. To process these
events, include handlers named Application_Start and
Application_End in Global.asax:
<script language=“C#” runat= “server”>
void Application_Start()
{
. . . // Display Welcome message, initialization, …
}
void Application_End()
{
Response.Write(“<hr />This page was last accessed
at ” + DateTime.Now.ToString());
}
</script>
6

Global.asax file Example for Web API
using System;
using System.Web.Http;
using HelloWebAPI.Configuration;
namespace MyWebApi
{
public class Global : System.Web.HttpApplication
{
protected void Application_Start(object sender, EventArgs e)
{
GlobalConfiguration.Configure(HelloWebAPIConfig.Register);
}
}
}

Application_Start event handler:
When the application starts, it runs
the code to register the api.

7

Additional Application Events
◼

There are many other application events that you can
handle by writing your handlers:
Event/handler

Description

Application_Start( )

Called the beginning of the application

Application_End( )

Called the end of the application

Session_Start( )

Called the beginning of the session

Session_End( )

Called the end of the session

Application_Error( )

Called when an unhandled error occurs

8

Per Request Event Handlers
Application_BeginRequest( )

Called at the beginning of each request the
appl. received, before the page is executed;

Application_EndRequest

Called after the page is executed at the end
of each request the application received;

Application_AuthenticateRequest( )

Called to authenticate the caller

Application_AuthorizeRequest( )

Called to determine whether the caller is
authorized to access the requested resource

Application_ResolveRequestCache( ) Called to resolve the current request by
providing content from a cache
Application_AcquireRequestState( )

Called to associate the current request with a
session and populate session state

Application_ReleaseRequestState( )

Called to release (store) any State associated
with this session

Application_UpdateRequestCache( ) Called to update a cache with content

returned in the response

9

Global Object / Variable in Global.asax
A global object/variable can facilitate the
communication among the
◼ Different sessions from different clients
◼ Pages within the same session (There are other
better ways for this purpose: session state)
◼ Need to address the monitoring/synchronization
issues, as we discussed in text Chapter 2.
◼

10

Global Object / Variable
In Global.asax file

Challenge 1:
Simultaneous
write?

<script language=“C#” runat=“server”>
public static Int32 globalCounter = 0;
</script>
<script language=“C#” runat=“server”>
private static Int32 globalCounter = 0;

Challenge 2:
Performance?

public void increment(Int32 newValue) {
lock(this) {
globalCounter = globalCounter + newValue;
}
</script>

11

DLL Files in an ASP.Net Web Application
MyWebApp

Subdir 1

.aspx
.aspx
.aspx
files
files
files

Global
.asax

Web
.config

.aspx
.aspx
.aspx
files
files
files

.ascx
.aspx
.aspx
files
files
files

Subdir 2

Web
.config

.aspx
.aspx
.aspx
files
files
files

Dynamic
Linking
Library
Files

bin

Web
.config

.dll
.aspx
.aspx
files
files
files

12

Creating DLL Components
An application can contain multiple classes (pages);
◼ The code of the classes (aspx.cs files) are not reusable
in other applications;
◼ The .aspx.cs file provides event handlers for the
controls in aspx page;
◼ In order to reuse the code, you can make this
component a service – a remote component;
◼ You can also create your own DLL library to collect
all your reusable classes. They are local components
and have better performance.
◼ Your library will form a namespace;
◼ Include your library in your application.
13
◼

Creating a Class Library Project
Source: https://learn.microsoft.com/en-us/dotnet/core/tutorials/library-with-visual-studio?pivots=dotnet-7-0

14

Add the DLL File into your Web Project
Create a new project of type "Class Library";
◼ Create a .cs page of classes that you will be using in your other
applications.
◼ After classes are created and compiled, go back to your
website project and do "Add Reference";
◼ Browse to the class library project, find the library, and add it
to your application project.
◼ A copy of the DLL file will be copied and pasted in the "bin"
directory in your application folder.
◼ Note, you must use the same .Net Framework version, e.g.,
4.72, to create the DLL library project and the Application
project.
◼

15

Create myLibrary in Class Library Project
Class 1

Class 2

namespace myLibrary{
public class TemperatureConversion {
public static Int32 getFahrenheit(Int32 c) {
Double f = c * 9 / 5 + 32;
return Convert.ToInt32(f);
}
public static Int32 getCelsius(Int32 f) {
Double c = (f - 32) * 5 / 9;
return Convert.ToInt32(c);
}
}
public class myMath {
public static long abs (long x) {
if (x >= 0) return (x); else return (-x);
}
}
}

16

Use the Functions in myLibrary
using myLibrary;

Include
myLibrary

Add Reference to
copy the code into
the application.

class myApplication {

static void Main(string[ ] args) {
Int32 Ctemp = 23;

Class
Name

Method
Name

Int32 Ftemp = 121;
double x = TemperatureConversion.getFahrenheit(Ctemp);
double y = TemperatureConversion.getCelsius(Ftemp);
System.Console.WriteLine("C-temp {0} is F-temp {1}", Ctemp , x);
System.Console.WriteLine("F-temp {0} is C-temp {1}", Ftemp , y);

}
}

double x = myLibrary.TemperatureConversion.getFahrenheit(Ctemp);

17

Wrapping Legacy Software into Web Service
There are many useful software components are
developed before Web service standards;
◼ They are in the form of library classes and functions,
such as DLL classes and functions;
◼ To wrap a library class into a service:
◼

Use a Web service template to start service development;
◼ Add Reference and load a library class into your service;
◼ Use the library class to implement your service;
◼ After you deploy the service, the library class becomes a
service;
◼ You may need re-implement a number of mechanisms, such
as input, output, and state management.
◼

18

M12 L3
Web State
Management:
Cookies

Lecture Outline
| What are Cookies
| Saving and Retrieving Cookies
| Cookie Application

2

Cookies: Storage on Client Computer
Cookies provide a way of storing user’s information
◼ in the browser (temporary, disappear after closing
browser)
◼ on the hard drive of client’s computer (longer term)
◼ Cookies are transparent to the users, as long as the
cookies are enabled in the browser;
◼ Cookies can store string type of data only, often used
for storing user’s preferences of the application;
◼ Other data types need to be converted to strings;
◼ The syntax of Cookies are similar to View State.
◼

3

Configure Your Browser to Enable Cookies

4

Testing a Website with cookies:
(1) Enter data (2) Close Browser (3) Reopen
http://venus.sod.asu.edu/WSRepository/CookiesTest/

Dem
o

Close the page and re-open the page

John Doe
John.Doe@asu.edu

5

Page Design

6

Code Saving and Retrieving Cookies
Create a new
cookie object
with a key

protected void Button1_Click(object sender, EventArgs e)
{
HttpCookie myCookies = new HttpCookie("myCookieId");
myCookies["Name"] = TextBox1.Text;
myCookies["Email"] = TextBox2.Text;
Add my content
to the cookies
myCookies.Expires = DateTime.Now.AddMonths(6);
collection
Response.Cookies.Add(myCookies);
lblUser.Text = "Name stored in cookies " + myCookies["Name"];
lblEmail.Text = "Email stored in cookies " + myCookies["Email"];
}
}
Read the content
and display at the
given label
7

Code Saving and Retrieving Cookies
Access a
cookie object
using a key

using System.Net; // needed for Cookies
public partial class _Default : System.Web.UI.Page {
protected void Page_Load(object sender, EventArgs e) {
HttpCookie myCookies = Request.Cookies["myCookieId"];
if ((myCookies == null) || (myCookies["Name"]=="")) {
Check if the
lblUser.Text = "Welcome, new user";
cookie exist or
} else {
is empty
lblUser.Text = "Welcome, " + myCookies["Name"];
lblEmail.Text = "We have your email " + myCookies["Email"];
}
Read cookie
}
content and
display at
given label

8

Application of cookies in Login
◼

Cookies are often used in saving the credentials

9

Code behind the Login Button
namespace LoginCookie {
public partial class LoginPage : Form {
public LoginPage()
{ InitializeComponent(); }
private void btnLogin_Click(object sender, EventArgs e) {
if ((txtUserId.Text != "") && (txtPassword.Text != ""))
{
String c = txtUserId.Text + “ ” + txtPassword.Text;
FormsAuthentication.RedirectFromLoginPage(c, ckbChecked);
}
else
Output.Text = "Invalid login, try again";
}
This method will compare the user ID
}
and the password saved in Web.config
}
file. To discuss in Chapter 6.

10

FormsAuthentication.RedirectFromLoginPage

FormsAuthentication.RedirectFromLoginPage
(txtUserId.Text, Persist);
true: create cookies to save the credential
false: no cookies for the credential

Applications of cookies will be further discussed in
later section and in Chapter 6 on security

11

Are Cookies Browser Dependent?
They are stored in a browser-specified location and
thus, the browser will search that location only.
Typically, the browser application folder;
◼ Cookies are normally not available cross browsers;
◼ However, cookies are stored in standard format and
can be transferred between the browsers.
◼ When you start to use a new browser, you often
receive this question: Do you want to copy your
user profiles from X browser?
◼

12

Are Cookies Secure?
Cookies are stored in local hard drive. It is as secure as other data
on your computer;
◼ Cookies (e.g., username and password) will be sent from your
local computer to the server for validation when you login. It is
not secure during the transmission. However, if you enter the
username and password, they are not secure either.
◼ The only solution is to have SSL connection (https). Chapter 6
will discuss how can you install SSL to enable secure connection
between client and server.
◼ HttpCookie class has a “Secure” property for user to check if SSL
is available:
◼

if (MyCookie.Secure)
{
// Use cookies, otherwise not
}

13

M12 L4
Web State
Management:
Session State

Lecture Outline
| What is Session State?
| Case Study: Creating a Shopping Site
| Cookie Support to Session State
| From Session State to Application State

2

Session State
View State and Cookie can store string data on client side:
◼ View State: in hidden fields in html page in web browser
◼ Cookie: in client machine’s hard drive
◼ Session state allows you to store structured objects in the server;
◼ The scope of session state is within all pages of the session, but
not cross different sessions;
◼ The syntax is similar to ViewState and Cookies
◼ The information in Session state is secure
◼

◼

◼

The information is linked to the session. Other sessions of the same
application cannot access the information;
A unique 120-bit hash number is generated to associate the user to the
session: The number is sent to user as an id, and the user session must carry
the ID in order to revisit the session. Try the service that can generate the
ID: http://venus.sod.asu.edu/WSRepository/Services/HashSha512/Service.svc
3

Understanding Session and State

Session

Browser

x

Browser

y

y
ASPX
Application

cart 2

z
Session
3

Browser

Session

Session
2

Issue a unique Hash ID number y
Session

Session
1

Shopping
cart 1

cart 3

4

Use Session State To Store Objects
http://venus.sod.asu.edu/WSRepository/SessionOnlineStore/Default.aspx
http://venus.sod.asu.edu/WSRepository/SessionOnlineStore/Default.aspx

5

Seller Page for Entering Information
Seller.aspx
http://venus.sod.asu.edu/WSRepository/SessionOnlineStore/seller.aspx

http://venus.sod.asu.edu/WSRepository/SessionOnlineStore/seller.aspx

6

Returns to Default.aspx Page

7

Default.aspx.cs -- Book Class Definition
public class Book
{ public string _Title;
public string _Isbn;
public double _Price;
public bool _InCart; // whether the book is in cart
public Book(string title, string isbn, double price)
{
_Title = title;
_Isbn = isbn;
_Price = price;
The constructor loads the
parameter values into the
_InCart = false;
class variables
}
}
8

Seller.aspx.cs
public partial class Seller : System.Web.UI.Page {
protected void Page_Load(object sender, EventArgs e) { }
protected void btnSubmitBook_Click(object sender, EventArgs e) {
string title = txtTitle.Text;
string isbn = txtIsbn.Text;
string sPrice = txtPrice.Text;
double price = Convert.ToDouble(sPrice);
Book aBook1 = new Book(title, isbn, price);
string num = Convert.ToString(Session.Count + 1); // Find the next free spot
string catalogKey = "sBook" + num; // Form the index key for next session spot
Session[catalogKey] = aBook1; // Add an object into session state
Response.Redirect("Default.aspx"); // Return to catalog page
}
protected void txtIsbn_TextChanged(object sender, EventArgs e){
// text change handler
Allow you to write an event handler to
}
response to the change of the text. For
}
9
example, auto update when a number changes

Default.aspx.cs
public partial class _Default : System.Web.UI.Page
Code to be executed
{
every time the page
Book aBook1, aBook2, aBook3;
is loaded/reloaded.
string indexKey;
protected void Page_Load(object sender, EventArgs e) {
if ((Session.Count != 0) && (ListBox1.Items.Count == 0)) {
aBook1 = (Book)Session["sBook1"];
ListBox1.Items.Add(aBook1._Title);
There is
The
information
aBook2 = (Book)Session["sBook2"];
ListBox is
available in
ListBox1.Items.Add(aBook2._Title);
empty
session state
aBook3 = (Book)Session["sBook3"];
ListBox1.Items.Add(aBook3._Title);
}
}
// Continued next page
10

Default.aspx.cs (Contd.)
protected void btnSeller_Click(object sender, EventArgs e)
{
Jump from Default
Response.Redirect("Seller.aspx");
page to Seller page
}
protected void btnViewBook_Click(object sender, EventArgs e) {
if (ListBoxCatalog.SelectedIndex < 0 )
No item selected
lblTitle.Text = "Please select a book in the list above";
else {
string num = Convert.ToString(ListBoxCatalog.SelectedIndex + 1);
indexKey = "sBook" + num; // Find the selected book
Book aBook = (Book)Session[indexKey];
lblTitle.Text = "<br />Title: " + aBook._Title;
lblIsbn.Text = "<br />ISBN: " + aBook._Isbn;
lblPrice.Text = "<br />Price: " + aBook._Price;
}
}

11

Default.aspx.cs: Add to Cart Button
protected void btnAddToCart_Click(object sender, EventArgs e)
{
string num = Convert.ToString(ListBoxCatalog.SelectedIndex + 1);
indexKey = "sBook" + num; // Find selected book
Book sBook = (Book)Session[indexKey]; // read from state variable
sBook._InCart = true;
// add information
Session[indexKey] = sBook;
// Write back
Response.Redirect("MyCart.aspx");
}
Use a boolean
variable here.
You could create a
new session state
array for the cart.

Jump from current (Default)
page to MyCart page

12

MyCart.aspx.cs
public partial class MyCart : System.Web.UI.Page {
protected void Page_Load(object sender, EventArgs e) {
Double totalAmount = 0;
for (Int16 i = 1; i <= Session.Count; i++) {
string indexKey = "sBook" + i;
Book aBook = (Book)Session[indexKey];
if (aBook._InCart) {
ListBoxCart.Items.Add(aBook._Title);
totalAmount = totalAmount + Convert.ToDouble(aBook._Price);
} }
lblTotalAmt.Text = "Total Amount: "+Convert.ToString(totalAmount);
}
Checkout
protected void btnToCatalog_Click(object sender, EventArgs e) {
page not
Response.Redirect("Default.aspx"); // continue shopping
shown in
}
this
example
protected void btnToCheckout_Click(object sender, EventArgs e) {
Response.Redirect(“Checkout.aspx");
13
}}

Cookie Support to Session State
❑ HTTP is stateless. Each visit is considered to be
from a new user;
❑ The browser needs to explicitly carry the session
ID (of 120 bits) when it revisits a session and its
session variable;
➢ Use a cookie to store the session id
➢ Put the session id in URL as a part of the address
<html>Page Language =
<%@
C# %> …
<html>
sum = sum + [input]
…
</html>
sum = sum + [input]
…
</html>

ASPX forms
ASPX.cs

14

Storing and Sending Session ID

➢
➢

Use a cookie to
store the session ID
ID is wrapped in HTTP package

x

Session

Cookie

x

Session

Server Side

Client
Browser

ASPX
Application

Client
Browser

➢
➢

ID is stored in browser in a hidden field
Put the session ID is wrapped in URL
as a part of the address

ASPX
Application
15

View State Security and Creating Machine Key

If Cookies not enabled
Creating Own Machine Key
Step 1: Download the secure hashing script
for generating the machine key:
https://support.microsoft.com/en-us/kb/2915218?wa=wsignin1.0

Step 2: In Windows Search: Windows Powershell ISE and
start it. Copy and paste the script code into the editor.
Step 3: Run the script by clicking the green triangle button
at the upper part of the window. Then, type the following
command at the prompt:

Session

Client
Browser

Server Farm
Computer 1

x

Computer
ASPX
2
Application
Computer
n

x is generated
using hashing
& machine key

was required for
using ASU-hosted
WebStrar Server

PS C:\scripts> Generate-Machinekey <enter>
Step 4: Add it into the project’s <system.web>
<machineKey decryption="AES" decryptionKey="xxxxxxxxxxxxxxxxxxxxxxx"
Web.config file in the element:
validation="HMACSHA256" validationKey="yyyyyyyyyyyyyyyyyyyyyyyyyy" />
</system.web>
16

When You Shop and Add Items in Cart
If you do not enable Cookies, you can go back and
forth between different pages, you can still see your
items in the shopping cart;
◼ If you close your session (browser), your items in the
cart will disappear.
◼ If you enabled cookies, your items in cart will stay
even if you have closed the browser;
◼ If you use a different browser, the items will not be
visible.
◼ If you save the cart items into a disk file associated
with your account, the items will be visible in different
browsers.
17
◼

HttpSessionState Class: Public Properties
◼
◼
◼

◼
◼

◼

◼

◼
◼
◼

◼

◼

Contents Gets a reference to the current session-state object.
Count Gets the number of items in the session-state collection.
IsCookieless Gets a value indicating whether the session ID is embedded in the URL or
stored in an HTTP cookie.
Mode Gets the current session-state mode.
IsNewSession Gets a value indicating whether the session was created with the current
request.
IsReadOnly Gets a value indicating whether the session is read-only.
IsSynchronized Gets a value indicating whether access to the collection of session-state
values is synchronized (thread safe).
Keys Gets a collection of the keys of all values stored in the session.
SessionID Gets the unique session ID used to identify the session.
StaticObjects Gets a collection of objects declared by <object Runat="Server"
Scope="Session"/> tags within the ASP.NET application file global.asax.
SyncRoot Gets an object that can be used to synchronize access to the collection of
session-state values.
Timeout Gets and sets the time-out period (in minutes) allowed between requests before
the session-state provider terminates the session. You can set the minutes in web.config
18
file

Session State Setting Using Web.config
1. UseCookies
2. UseUri
3. UseDeviceProfile
4. AutoDetect
<system.web>
<sessionState
cookieless = “HttpCookieMode values”
timeout = “int, number of minutes”
…>
</sessionState>
</system.web>

19

HttpCookieMode Values

1. UseCookies
2. UseUri
3. UseDeviceProfile
4. AutoDetect

UseCookies: Always assume that cookies
are supported by browser and are enabled.
◼ Session will not work if cookies are not enabled
◼ UseUri: There are potential problems:
◼ If an absolute path is used in the program, storing session id
in browser and use URL will cause an page error.
◼ Session variables discarded after the session is terminated.
◼ UseDeviceProfile: It checks if the browser supports cookies. If it
does, set mode to UseCookies; Otherwise, set mode to UseUri.
◼ AutoDetect: It checks if the browser supports cookies and tests
if the cookie is enabled, by creating a cookie, saving it, and
retrieving it. It is slow as it needs to go back and forth several
times between the server and client. Otherwise, set mode to
UseUri (mostly in mobile devices).
20
◼

HttpSessionState Class: Public Methods
◼
◼
◼
◼

◼

◼

◼
◼
◼
◼

◼

Abandon Cancels the current session.
Add Adds a new item to session state, or use Session[“key”] = x;
Clear Clears all values from session state.
CopyTo Copies the collection of session-state values to a onedimensional array, starting at the specified index in the array.
Equals (inherited from Object) Overloaded. Determines whether two
Object instances are equal.
GetEnumerator Gets an enumerator of all session state-values in the
current session.
GetType (inherited from Object) Gets the Type of the current instance.
Remove Deletes an item from the session-state collection.
RemoveAll Clears all session-state values.
RemoveAt Deletes an item at a specified index from the session-state
collection.
ToString (inherited from Object) Returns a String that represents the
current Object.
21

Using Add and Remove Methods
string itemName = Server.HtmlEncode(TextBox1.Text);
string itemValue = Server.HtmlEncode(TextBox2.Text);
Session.Add(itemName, itemValue);
// Same as Session[itemName] = itemValue;

RedundantItem itemToRemove = e.Item;
string sessionItemToRemove =
((Label)itemToRemove.FindControl("Label1")).Text;
Session.Remove(sessionItemToRemove);

22

From Session State to Application State
Session[“index”] allows you to store an object into
server memory, and all pages in the session can access
the session variable. But data will disappear after
closing the browser
◼ Application[“index”] allows you to store an object into
server memory. All sessions and all pages in each
session can access the application variable;
◼ You can define, for example, Application[“SuperCounter”],
◼

similar to the Global.asax file and access the variable in each
session;
◼ The challenges remain here: write-write conflict and lock
performance, if the application is frequently accessed.
23

M12 L5
Web State
Management:
File System

Lecture Outline
| File system operations: read and write
| Save web data into XML file on server
| Accessing your files
| From XML files to XML database

2

Save Data Permanently into Server Disk
All techniques discussed so far are not permanent. Data
can disappear for different reasons.
• Session state data disappears after the session is closed.
• Application state data (e.g., the global counter) will
also disappear if the application is closed. When?
Save into a text file;
◼ Save into a binary file;
◼ Save into an XML file
using the XML Writer;
◼ Save into database;
◼

Text chapter 10

Stream read a string;
◼ Read structured variable;
◼ XMLDocument class;
◼

◼

Read from database;
3

File System Read (and Write) XML Files
OS
operations,
not a part
of ASP .Net

1.
2.
3.
4.

Declare a reference FS of a FileStream type;
Open a file for read or write: It creates a buffer that can hold a block of bytes;
Copy the first block of a file into the buffer;
Create an XML reader or writer that uses the reference to read/write data in
the buffer;
5. When the reference moves down to the end of the buffer, the next block is
fetched.
6. Close the file
memory
File on disk, also called a stream
FS: a reference to the file

Copy a
block into
the buffer

StreamBuffer

A block
XML
reader or
writer

4

Other
data
sources

Define path
and file
name

Define path
and file
name

Path Class

Path Class

File System

Data elements

Stream Buffer

Stream Buffer

XML Writer

Data elements

TextBox
input

FileStream
FileStream
Class
Class
Standard
File
Operations

XML Reader

A Scenario of XML Data Exchange between
ASP application and File System

GridView
TreeView
ListBox
Label

Other data
consumers

5

.Net System.IO Namespace and its Classes
Namespace System.IO has a number of classes.
◼ Path class specifies the path and file name to be
accessed;
◼ FileStream class creates a buffer and connection to
the file system;
◼

string p= @“c:cse445\fileAccess\App_Data\Book.xml”
string fName = Path.GetFileName(p);
Book.xml

string p1 = @“c:cse445\”
string p2 = @“fileAccess\App_Data\Book.xml”
string location= Path.Combine(p1, p2);
6

Save Data into an XML-File on Server

7

Book.xml Generated through XMLWriter

8

Save Data into XML-File on Server

You can see a better formatted display at this page:
http://venus.sod.asu.edu/WSRepository/XMLDocReadWriteApp/Default.aspx
http://webstrar1.fulton.asu.edu/page1/Default.aspx
9

Code Behind the Default Page

public partial class _Default : System.Web.UI.Page {
protected void btnSeller_Click(object sender, EventArgs e) {
Response.Redirect("seller.aspx");
Find path to
}
the current
protected void btnShowBook_Click(object sender, EventArgs e) {
location
FileStream fS = null;
string fLocation = Path.Combine(Request.PhysicalApplicationPath,
@"App_Data\Book.xml"); // or: HttpRuntime.AppDomainAppPath
Open for
try {
read only
Check if the file exists
if (File.Exists(fLocation)) {
FileStream fS= new FileStream(fLocation, FileMode.Open, FileAccess.Read);
XmlDocument xd = new XmlDocument();
Load the XML file
xd.Load(fS);
into memory
fS.Close();
Close the file immediately
after loading the entire tree.
10

Code Behind the Default (Reader) Page
XmlNode node = xd;
XmlNodeList children = node.ChildNodes;
foreach (XmlNode child in children)
{
ListBox1.Items.Add(child.InnerText);
}
}
finally {
fS.Close();
}
}
}

In case the
session
crashes

This part of the code needs to be
refined, using what you have done
in Project 4 XML processing.

11

Code Behind the Data Enter (Writer) Page
public partial class Seller : System.Web.UI.Page {
protected void Page_Load(object sender, EventArgs e) {
}
protected void btnEnterBook_Click(object sender, EventArgs e) {
string title1 = txtTitle1.Text;
string isbn1 = txtIsbn1.Text;
string sPrice1 = txtPrice1.Text;
Taking
Takingdata
data
from
fromtext
text
boxes
boxes

string title2 = txtTitle2.Text;
string isbn2 = txtIsbn2.Text;
string sPrice2 = txtPrice2.Text;
string title3 = txtTitle3.Text;
string isbn3 = txtIsbn3.Text;
string sPrice3 = txtPrice3.Text;
12

Code Behind the Data Enter (Writer) Page
string fLocation = Path.Combine(Request.PhysicalApplicationPath,
@"App_Data\Book.xml"); // or: HttpRuntime.AppDomainAppPath
FileStream fS = null;
try {
fS = new FileStream(fLocation, FileMode.Truncate);
XmlTextWriter writer = new XmlTextWriter(fS,
System.Text.Encoding.Unicode);
Delete the existing
writer.Formatting = Formatting.Indented;
content.
writer.WriteStartDocument();
Other modes
writer.WriteStartElement("Books");
include
writer.WriteStartElement("Book");
OpenOrCreate,
Append, …
writer.WriteElementString("Title", title1);
writer.WriteElementString("Isbn", isbn1);
writer.WriteElementString("Price", sPrice1);
writer.WriteEndElement();
See chapter 4
slides on
XMLWriter
13

Code Behind the Data Enter (Writer) Page
writer.WriteStartElement("Book");
writer.WriteElementString("Title", title2);
writer.WriteElementString("Isbn", isbn2);
writer.WriteElementString("Price", sPrice2);
writer.WriteEndElement();
writer.WriteStartElement("Book");
writer.WriteElementString("Title", title3);
writer.WriteElementString("Isbn", isbn3);
writer.WriteElementString("Price", sPrice3);
writer.WriteEndElement();
writer.WriteEndElement();
writer.WriteEndDocument();
writer.Close();
fS.Close();
It is necessary to close the
XMLWriter and
and to
to close
close the
the file
file
}
stream connection. You cannot
open the file if any one is open.

XMLWriter
continues to
wrote

14

Code Behind the Data Enter (Writer) Page
finally {
fS.Close();
}

In case the
session
crashes

Response.Redirect("Default.aspx");
}

protected void txtIsbn_TextChanged(object sender, EventArgs e)
{
// can write an event handler to do something as user types
}
}

15

Discussions: Book.xml (Catalog) File
Book.xml is the catalog file and is accessible by the
public;
◼ It can be read by many shoppers simultaneously
◼

FileStream fS= new FileStream(fLocation, FileMode.Open, FileAccess.Read);
Multiple sessions can open and read at the same time.
Other modes are FileAccess.Write and FileAccess.ReadWrite

◼

Many sellers can try to write it simultaneously
FileStream fS= new FileStream(fLocation, FileMode.Open, FileAccess.Write);
Write operations must be locked from other reads or writes.

◼

Is a deadlock possible on Book.xml ?
16

Consider a Business Model with …
public class StoreItem { // for catalog
public string _ItemName;
public string _ItemNo;
public double _UnitPrice;
public int _Stock; // Number of items available in store
public int _InCart; // Number of items in customer carts
}
Use these two numbers to predict
how many items should be ordered.
• Order too many: product cost and
storage cost
• Order too few: lose business
opportunity

public class CartItem{
public string _ItemName;
public string _ItemNo;
public double _UnitPrice;
public int _Amount; // Number of items in shopping cart
public bool _InStock
}

17

Managing Your Data Files
StoreItems.xml

int _Stock
int _InCart

When a client adds an item into cart:
Open InCartItem[i].xml;
InCartItems[i].xml
_Amount++
Open StoreItems.xml
_InCart++;
Close InCartItem[i].xml
int _Amount;
Close StoreItems.xml
bool _InStock

The store orders 10 more items:
Open StoreItems.xml
_Stock = _Stock+10;
Open InCartItem[i].xml;
_InStore = true
Close StoreItems.xml
Close InCartItem[i].xml
18

Dead Lock

Dead Lock Prevention

When a client adds an item in cart:
Open InCartItem[i].xml;
_Amount++
Open StoreItems.xml
_InCart++;
Close InCartItem[i].xml
Close StoreItems.xml

When a client adds an item in cart:
Open InCartItem[i].xml;
_Amount++
Close InCartItem[i].xml
Open StoreItems.xml
_InCart++;
Close StoreItems.xml

The store orders 10 items:
Open StoreItems.xml
_Stock = _Stock+10;
Open InCartItem[i].xml;
_InStore = true
Close StoreItems.xml
Close InCartItem[i].xml

The store orders 10 items:
Open StoreItems.xml
_Stock = _Stock+10;
Close StoreItems.xml
Open InCartItem[i].xml;
_InStore = true
Close InCartItem[i].xml
19

XML File vs. XML Database
◼

XML file access models
DOM model: read the entire XML file into memory
◼ SAX model: Read one node at a time into memory
◼

◼

If XML file is very big, none of the models work:
It takes too much memory;
◼ It takes too much time to sequentially traversing a large file.
◼

◼

XML database is the solution (Text Chapter 10):
It creates index for fast search
◼ It runs the search code in database machine, instead of the
client machine.
◼ It similar to a relational database in query processing
◼

20

Databases, Web Services, and Web Applications
GUI;
Service-Oriented
Desktop
Applications

GUI;
Service-Oriented
Website / HTML
Applications

GUI;
Service-Oriented
Mobile and
IoT
Applications

GUI;
Composite
Services in
BPEL / WF

XML
Query

Network
Services
Service
and
Service
and
and
objects
objects
objects
Server and
Data management

Relational
Databases
DB
SQL

OLE
Oracle

Query

text

Data Provider
Connection Methods
DataAdapter
DataReader
DataWriter
adapter

...

<…>

XML

XML
database

<…>

DataSet

Ontology
A set of tables &
an XML tree 21

